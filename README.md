# Letovo Analytics Calendar Maker
#### Микро-служба, позволяющая интегрировать расписание из ЛК в формат iCal
<hr>

## Алгоритм работы
Клиент заходит в ЛК, и в нём нажимает кнопку "Подписаться на расписание", после чего запрос направляется к ЛК.
ЛК, в свою очередь, перенаправляет запрос на службу в `create_token.php`, которая создаёт новый токен в БД, ассоциирует его с пользователем и возвращает его. ЛК отображает ссылку на `index.php` с префиксом `webcal://` и параметром `token`, встроенными в ссылку, и в браузере пользователя будет предложено подписаться на календарь.
После этого клиент будет с интервалом обращаться к `index.php` со своим токеном, скрипт будет обращаться к БД за именем пользователя, после чего обратится к ЛК за расписанием, переведёт его из JSON в iCal и вернёт клиенту.<br>

## Структура
Служба хостится как отдельный сайт третьего/четвёртого домена (`cal.site.ru`/`cal.students.site.ru`). Содержит в себе три типа файлов - открытые, закрытые и полностью локальные.

#### Открытые файлы
К открытым относится `index.php`, к которому обращается клиент для обновления информации. Скрипт делает запрос к ЛК, который в ответ на имя пользователя даёт расписание в формате JSON.
В скрипте ограничена частота обращений для каждого пользователя в ЛК. В качестве входных данных требует лишь токен, с которым у него есть ассоциация в БД с именем пользователя.
В ответ даёт интерпретацию полученного JSON в формате календаря iCal.

#### Закрытые файлы
Файлы управления токенами (директория `management`) - `create_token.php`, `check_tokens.php` и `delete_token.php` - создающий токен, возвращающий токены пользователя и удаляющий токены соответственно.
**К ним должен иметь доступ только ЛК, выступая как интерфейс для пользователя и прокси**
##### `create_token.php`
Создаёт 16-символьный токен из цифр и латинских символов разного регистра в БД и ассоциирует его с именем пользователя и описанием. На вход принимает имя пользователя __(str, до 32 символов, обязательный параметр)__ и описание для идентификации устройства, на котором будет использоваться токен __(str, до 255 символов, опциональный параметр)__. Возвращает JSON с именем пользователя, сгенерированным токеном и описанием, сохранёнными в БД. В случае, если с именем пользователя ассоциировано 4 и более токенов, в операции будет отказано.
###### `management/create_token.php?username=2024genken.gf&description=iPhone 11 Pro Max`
```
{
   "status":"success",
   "code":0,
   "user":{
      "name":"2024genken.gf",
      "token":"Rs2sB8ZG3Jou7rVx",
      "description":"iPhone 11 Pro Max"
   }
}
```

##### `check_tokens.php`
Возвращает список токенов, ассоциированных с заданным именем пользователя. Выводит описание, первые четыре символа токена в открытом виде (остальные заменены на звёздочки) и время последнего обращения по этому токену.
###### `management/check_tokens.php?username=2024genken.gf`
```
[
      {
         "description":"iPhone 11 Pro Max",
         "token":"Rs2s************",
         "refreshed":"2000-01-01 00:00:00"
      },
      {
         "description":"XEON-ПК",
         "token":"1234***********",
         "refreshed":"2021-04-24 20:00:56"
      }
]
```

##### `delete_token.php`
Удаляет токены из БД, начинающиеся на заданную строку и ассоциированный с заданным именем пользователя. На вход принимает имя пользователя __(str, до 32 символов, обязательный параметр)__, и начальные символы токена __(str **[не список!]**, до 16 символов, опциональный параметр; если не задать или оставить пустым, удалятся все токены пользователя)__. В ответ даёт всю информацию об успешно удалённых токенах в открытом виде.
###### `management/delete_token.php?username=2024genken.gf&token_start=Rs2s`
```
{
      "status":"success",
      "code":0,
      "tokens":[
         {
            "username":"2024genken.gf",
            "token":"Rs2sB8ZG3Jou7rVx",
            "refreshed":"2000-01-01 00:00:00",
            "description":"iPhone 11 Pro Max"
         }
      ]
}
```

#### Полностью локальные файлы
К ним относится файл `db.php`, содержащий в себе инициализацию подключения к БД. **Он не должен быть доступен извне ни для общей сети, ни для ЛК, а только непосредственно из ФС.**

## Устройство БД
Служба разработана на БД MySQL, содержащей одну таблицу с четырьмя столбцами:
- `username`, `varchar(32)` - имя пользователя, который использует токен. Использование более четырёх записей в таблице с одним и тем же значением этого столбца не допускается. 
- `token`, `char(16)` - токен, по которому можно определить имя пользователя. Каждое значение в столбце должно быть уникально. Состоит из цифр и латинских символов разного регистра, длина ровно 16 символов.
- `refreshed`, `timestamp` - временная метка последнего запроса по токену, ограничивающая частоту запросов. По умолчанию при создании новой записи устанавливается в `2000-01-01 00:00:00`
- `description`, `tinytext` - описание устройства, на котором используется метка, задаётся пользователем в интерфейсе ЛК **[нужна защита от SQL-инъекций]**, может быть пустым, но не более 255 символов.

Для быстрого создания таблицы используется следующая SQL-запись:
```
create table cal
(
	username varchar(32) null comment 'Username',
	token char(16) null comment 'User''s token',
	refreshed timestamp default '2000-01-01 00:00:00' null comment 'Last refresh',
	description tinytext null comment 'Description of the device that uses this token',
	constraint cal_token_uindex
		unique (token)
)
comment 'Main iCal Service table';
```

## Синтаксис iCal
### Формат тегов
Каждый тег размещён на отдельной строке. Тег может быть либо оперативным и указывать на начало заголовка _(например, `BEGIN:VCALENDAR`)_, или присваивающими _(например, `VERSION:2.0`)_.
Рассмотрим пример, который возвращается тестовым JSON, встроенным в `index.php`.

- `BEGIN:VCALENDAR` - оператор, сообщающий парсеру о начале календарного файла. В случае с подписными и локальными календарями, этот тег может быть в единственном количестве, второй и последующие будут проигнорированы парсером.
- `VERSION:2.0` - версия календаря. Данный тег является обязательным.
- `PRODID:-//Letovo School/SelfGovernment/Genken//Analytics iCal Timetable Maker v2.0//RU` - информация о генераторе этого файла в формате `-//[организация]//[продукт]//[язык]`. Данный тег является обязательным.
- `CREATED:20210426T194455` - временная метка создания календарного файла в формате `YYYYMMDD\THHMMSS`. Необязательный параметр.
- `X-WR-CALNAME:Школьное расписание` - название календаря (для устаревших клиентов Microsoft), обязательный параметр.
- `NAME:Школьное расписание` - название календаря (как прописано в RFC). Обязательный параметр.
- `CALSCALE:GREGORIAN` - формат календаря (японский/хинди/etc.). Необязательный параметр.
- `REFRESH-INTERVAL;VALUE=DURATION:P10M` - частота обновления подписного календаря. Не всегда рабочий параметр, т. к. время задаётся клиентом, но важный для устаревших клиентов.
- `BEGIN:VTIMEZONE` - оператор, сообщающий парсеру о начале инициализации часового пояса. В случае с мультизональностью пользователей, важный параметр.
- `TZID:Europe/Moscow` - ID часового пояса. Некоторые современные клиенты могут инициализировать часовой пояс по этому параметру, но он также нужен при указании часового пояса в событиях. Необязательный, но важный параметр.
- `TZURL:http://tzurl.org/zoneinfo-outlook/Europe/Moscow` - URL, подтверждающий информацию о часовой зоне. Необязательный, но важный параметр.
- `X-LIC-LOCATION:Europe/Moscow` - то же, что и `TZID`, но добавленный для совместимости с некоторыми клиентами.
- `BEGIN:STANDARD` - оператор, сообщающий парсеру о начале установки часового пояса по умолчанию. Необязательный параметр, нужен для надёжности и совместимости.
- `TZOFFSETFROM:+0300` - начало диапазона отклонения от Гринвича (`UTC+0000`). Необязательный параметр.
- `TZOFFSETTO:+0300` - конец диапазона отклонения от Гринвича (`UTC+0000`). Необязательный параметр.
- `TZNAME:MSK` - название часового пояса по умолчанию, нужен некоторым клиентам. Необязательный параметр.
- `DTSTART:19700101T000000` - дата начала отображения событий, помеченных с этим часовым поясом. Необязательный параметр.
- `END:STANDARD` - оператор, сообщающий парсеру об окончании инициализации часового пояса по умолчанию. Необязательный параметр.
- `END:VTIMEZONE` - оператор, сообщающий парсеру об окончании инициализации часового пояса.
- `BEGIN:VEVENT` - оператор, сообщающий парсеру об окончании инициализации события. Может повторяться.
- `UID:7d199ccfb4e2f634565ff11209e83b3a-20210426T194455:2024genken.gf@student.letovo.ru` - уникальный ID события, введён для устранения дубликатов событий при пересылке и случайном дублировании. **Для нелокальных календарей обязателен, в случае отсутствия событие проигнорируется парсером и не отобразится.** В данном случае генератор составляет его из MD5 названия урока и группы, времени генерации события и почты. Обязательный параметр.
- `BEGIN:VALARM` - оператор, сообщающий парсеру о начале инициализации уведомления. Важно, но необязательно.
- `ACTION:DISPLAY` - форма уведомления (баннер/звук). Необязательный параметр.
- `DESCRIPTION:Русский язык` - текст уведомления. Необязательный параметр.
- `TRIGGER:-PT2M` - условие уведомления. В нашем случае, это момент за две минуты до события. Необязательный параметр.
- `END:VALARM` - оператор, сообщающий парсеру об окончании инициализации уведомления.
- `URL:https://letovo.zoom.us/j/96619520927` - URL события (технически ни на что не влияет, но является частью описания события). Необязательный параметр.
- `LOCATION:209` - место события. Необязательный, но важный параметр.
- `DESCRIPTION:Прочитать Евгения онегина` - описание события. Необязательный параметр.
- `DTSTART;TZID=Europe/Moscow:20210425T124000` - начало события. Обязательный параметр.
- `DTEND;TZID=Europe/Moscow:20210425T132000` - окончание события. Обязательный параметр.
- `SUMMARY:Русский язык, RUS-8-1` - главное название события. Обязательный параметр.
- `END:VEVENT` - оператор, сообщающий парсеру об окончании инициализации события.
- `END:VCALENDAR` - оператор, сообщающий парсеру о конце календарного файла. Как правило, все строки после него игнорируются парсером.
