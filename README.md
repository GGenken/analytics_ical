# Letovo Analytics Calendar Maker [OOP]
#### Микро-служба, позволяющая интегрировать расписание из ЛК в формат iCal
<hr>

## Алгоритм работы
Клиент заходит в ЛК, и в нём нажимает кнопку "Подписаться на расписание", после чего запрос направляется к ЛК.
ЛК, в свою очередь, перенаправляет запрос на службу в `create_token.php`, которая создаёт новый токен в БД, ассоциирует его с пользователем и возвращает его. ЛК отображает ссылку на `index.php` с префиксом `webcal://` и параметром `token`, встроенными в ссылку, и в браузере пользователя будет предложено подписаться на календарь.
После этого клиент будет с интервалом обращаться к `index.php` со своим токеном, скрипт будет обращаться к БД за именем пользователя, после чего обратится к ЛК за расписанием, переведёт его из JSON в iCal и вернёт клиенту.<br>

## Структура
Служба хостится как отдельный сайт третьего/четвёртого домена (`cal.site.ru`/`cal.students.site.ru`). Содержит в себе три типа файлов - открытые, закрытые и полностью локальные.

#### Открытые файлы
К открытым относится `index.php` в папке `c`, к которому обращается клиент для обновления информации. Скрипт делает запрос к ЛК, который в ответ на имя пользователя даёт расписание в формате JSON.
В скрипте ограничена частота обращений для каждого пользователя в ЛК. В качестве входных данных требует лишь токен, с которым у него есть ассоциация в БД с именем пользователя.
В ответ даёт интерпретацию полученного JSON в формате календаря iCal.

#### Закрытые файлы
Файлы управления токенами (директория `management`) - `create_token.php`, `check_tokens.php` и `delete_token.php` - создающий токен, возвращающий токены пользователя и удаляющий токены соответственно.
**К ним должен иметь доступ только ЛК, выступая как интерфейс для пользователя и прокси**
##### `create_token.php`
Создаёт 16-символьный токен из цифр и латинских символов разного регистра в БД и ассоциирует его с именем пользователя и описанием. На вход принимает имя пользователя __(str, до 32 символов, обязательный параметр)__ и описание для идентификации устройства, на котором будет использоваться токен __(str, до 255 символов, опциональный параметр)__.
Возвращает JSON со сгенерированным токеном, ассоциированным в БД с заданным пользователем. В случае, если с именем пользователя ассоциировано 4 и более токенов, в операции будет отказано.
###### `management/create_token.php?analytics_token=31ZWzYYMGZIkkpYo31ZWzYYMGZIkkpYo&description=Андроид
```
{
   "status":"success",
   "token":"6VC3Nrpl2i0MnTnD"
}
```

##### `check_tokens.php`
Возвращает список токенов, ассоциированных с заданным именем пользователя. Выводит описания, токены в открытом виде и время последнего обращения по этим токенам.
###### `management/check_tokens.php?analytics_token=31ZWzYYMGZIkkpYo31ZWzYYMGZIkkpYo
```
{
   "tokens":[
      "31ZWzYYMGZIkkpYo",
      "5nqs9mWiX0XIPgfA",
      "DZEc2LmYyAZs4Ayk",
      "SD0eF6WCn73rF1aW"
   ],
   "descriptions":[
      "Андроид",
      "",
      "",
      ""
   ],
   "usages":[
      "2021-05-12 00:46:31",
      "2020-01-01 00:00:00",
      "2020-01-01 00:00:00",
      "2020-01-01 00:00:00"
   ]
}
```

##### `delete_token.php`
Удаляет токен из БД, с заданным номером и ассоциированный с заданным токеном Аналитики. На вход принимает токен Аналитики __(str, до 32 символов, обязательный параметр)__, и сам токен девайса полностью.
В ответ даёт сам токен в открытом виде.
###### `management/delete_token.php?username=2024genken.gf&token_start=Rs2s`
```
{
    "status":"success",
    "deleted_token":"31ZWzYYMGZIkkpYo"
}
```

#### Полностью локальные файлы
К ним относится файлы `db.php` из корня и `users.php` из папки `classes`, содержащие в себе инициализацию подключения к БД и объектов календаря. **Они не должны быть доступны извне ни для общей сети, ни для ЛК, а только непосредственно из ФС.**

## БД
Для быстрого создания таблицы используется следующая SQL-запись:
```
create table analytics_data
(
	analytics_token char(32) not null comment 'A token used to identify a user in Analytics'
		primary key,
	lessons_cache text null comment 'Cached JSON data received from Analytics',
	cache_timestamp timestamp default '2020-01-01 00:00:00' not null comment 'A timestamp when the lessons were cached'
)
comment 'Table that keeps analytics tokens and cache received from Analytics';

create table device_tokens
(
	analytics_token char(32) not null comment 'Token used to access timetable from Analytics',
	device_token char(16) not null comment 'Token used by device to access the timetable',
	last_used timestamp default '2020-01-01 00:00:00' not null comment 'Timestamp when token was last used',
	description tinytext null comment 'Description of the device that uses the token',
	constraint device_tokens_analytics_token_device_token_uindex
		unique (analytics_token, device_token),
	constraint device_tokens_analytics_data_analytics_token_fk
		foreign key (analytics_token) references analytics_data (analytics_token)
			on update cascade on delete cascade
)
comment 'A table for user''s device tokens to contact between service and client';
```

## Синтаксис iCal
### Формат тегов
Каждый тег размещён на отдельной строке. Тег может быть либо оперативным и указывать на начало заголовка _(например, `BEGIN:VCALENDAR`)_, или присваивающими _(например, `VERSION:2.0`)_.
Рассмотрим пример, который возвращается тестовым JSON, встроенным в `index.php`.

- `BEGIN:VCALENDAR` - оператор, сообщающий парсеру о начале календарного файла. В случае с подписными и локальными календарями, этот тег может быть в единственном количестве, второй и последующие будут проигнорированы парсером.
- `VERSION:2.0` - версия календаря. Данный тег является обязательным.
- `PRODID:-//Letovo School/SelfGovernment/Genken//Analytics iCal Timetable Maker v2.0//RU` - информация о генераторе этого файла в формате `-//[организация]//[продукт]//[язык]`. Данный тег является обязательным.
- `CREATED:20210426T194455` - временная метка создания календарного файла в формате `YYYYMMDD\THHMMSS`. Необязательный параметр.
- `X-WR-CALNAME:Школьное расписание` - название календаря (для устаревших клиентов Microsoft), обязательный параметр.
- `NAME:Школьное расписание` - название календаря (как прописано в RFC). Обязательный параметр.
- `CALSCALE:GREGORIAN` - формат календаря (японский/хинди/etc.). Необязательный параметр.
- `REFRESH-INTERVAL;VALUE=DURATION:P10M` - частота обновления подписного календаря. Не всегда рабочий параметр, т. к. время задаётся клиентом, но важный для устаревших клиентов.
- `BEGIN:VTIMEZONE` - оператор, сообщающий парсеру о начале инициализации часового пояса. В случае с мультизональностью пользователей, важный параметр.
- `TZID:Europe/Moscow` - ID часового пояса. Некоторые современные клиенты могут инициализировать часовой пояс по этому параметру, но он также нужен при указании часового пояса в событиях. Необязательный, но важный параметр.
- `TZURL:http://tzurl.org/zoneinfo-outlook/Europe/Moscow` - URL, подтверждающий информацию о часовой зоне. Необязательный, но важный параметр.
- `X-LIC-LOCATION:Europe/Moscow` - то же, что и `TZID`, но добавленный для совместимости с некоторыми клиентами.
- `BEGIN:STANDARD` - оператор, сообщающий парсеру о начале установки часового пояса по умолчанию. Необязательный параметр, нужен для надёжности и совместимости.
- `TZOFFSETFROM:+0300` - начало диапазона отклонения от Гринвича (`UTC+0000`). Необязательный параметр.
- `TZOFFSETTO:+0300` - конец диапазона отклонения от Гринвича (`UTC+0000`). Необязательный параметр.
- `TZNAME:MSK` - название часового пояса по умолчанию, нужен некоторым клиентам. Необязательный параметр.
- `DTSTART:19700101T000000` - дата начала отображения событий, помеченных с этим часовым поясом. Необязательный параметр.
- `END:STANDARD` - оператор, сообщающий парсеру об окончании инициализации часового пояса по умолчанию. Необязательный параметр.
- `END:VTIMEZONE` - оператор, сообщающий парсеру об окончании инициализации часового пояса.
- `BEGIN:VEVENT` - оператор, сообщающий парсеру об окончании инициализации события. Может повторяться.
- `UID:7d199ccfb4e2f634565ff11209e83b3a-20210426T194455:2024genken.gf@student.letovo.ru` - уникальный ID события, введён для устранения дубликатов событий при пересылке и случайном дублировании. **Для нелокальных календарей обязателен, в случае отсутствия событие проигнорируется парсером и не отобразится.** В данном случае генератор составляет его из MD5 названия урока и группы, времени генерации события и почты. Обязательный параметр.
- `BEGIN:VALARM` - оператор, сообщающий парсеру о начале инициализации уведомления. Важно, но необязательно.
- `ACTION:DISPLAY` - форма уведомления (баннер/звук). Необязательный параметр.
- `DESCRIPTION:Русский язык` - текст уведомления. Необязательный параметр.
- `TRIGGER:-PT2M` - условие уведомления. В нашем случае, это момент за две минуты до события. Необязательный параметр.
- `END:VALARM` - оператор, сообщающий парсеру об окончании инициализации уведомления.
- `URL:https://letovo.zoom.us/j/96619520927` - URL события (технически ни на что не влияет, но является частью описания события). Необязательный параметр.
- `LOCATION:209` - место события. Необязательный, но важный параметр.
- `DESCRIPTION:Прочитать Евгения онегина` - описание события. Необязательный параметр.
- `DTSTART;TZID=Europe/Moscow:20210425T124000` - начало события. Обязательный параметр.
- `DTEND;TZID=Europe/Moscow:20210425T132000` - окончание события. Обязательный параметр.
- `SUMMARY:Русский язык, RUS-8-1` - главное название события. Обязательный параметр.
- `END:VEVENT` - оператор, сообщающий парсеру об окончании инициализации события.
- `END:VCALENDAR` - оператор, сообщающий парсеру о конце календарного файла. Как правило, все строки после него игнорируются парсером.